version: "3.8"

services:
  mysql-test:
    image: mysql:8.0
    container_name: bmn-v2-mysql-test
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-bmn_root_password}
      MYSQL_DATABASE: bmn_v2_test
      MYSQL_USER: ${MYSQL_USER:-bmn}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-bmn_dev_password}
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --default-authentication-plugin=mysql_native_password
    tmpfs:
      - /var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-bmn_root_password}"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 20s
    networks:
      - bmn-test-network

  wordpress-test:
    image: wordpress:latest
    container_name: bmn-v2-wordpress-test
    environment:
      WORDPRESS_DB_HOST: mysql-test
      WORDPRESS_DB_NAME: bmn_v2_test
      WORDPRESS_DB_USER: ${MYSQL_USER:-bmn}
      WORDPRESS_DB_PASSWORD: ${MYSQL_PASSWORD:-bmn_dev_password}
      WORDPRESS_TABLE_PREFIX: wptests_
      WORDPRESS_CONFIG_EXTRA: |
        define('WP_DEBUG', true);
        define('WP_DEBUG_LOG', true);
        define('SCRIPT_DEBUG', true);

        define('WP_ALLOW_MULTISITE', true);
        define('MULTISITE', true);
        define('SUBDOMAIN_INSTALL', false);
        define('DOMAIN_CURRENT_SITE', 'localhost');
        define('PATH_CURRENT_SITE', '/');
        define('SITE_ID_CURRENT_SITE', 1);
        define('BLOG_ID_CURRENT_SITE', 1);

        define('WP_TESTS_DOMAIN', 'localhost');
        define('WP_TESTS_EMAIL', 'admin@localhost.dev');
        define('WP_TESTS_TITLE', 'BMN Boston V2 Tests');
        define('WP_PHP_BINARY', 'php');
    volumes:
      - ./wp-content:/var/www/html/wp-content
    depends_on:
      mysql-test:
        condition: service_healthy
    networks:
      - bmn-test-network

  phpunit:
    image: wordpress:cli
    container_name: bmn-v2-phpunit
    user: "33:33"
    environment:
      WORDPRESS_DB_HOST: mysql-test
      WORDPRESS_DB_NAME: bmn_v2_test
      WORDPRESS_DB_USER: ${MYSQL_USER:-bmn}
      WORDPRESS_DB_PASSWORD: ${MYSQL_PASSWORD:-bmn_dev_password}
      WP_TESTS_DIR: /tmp/wordpress-tests-lib
      WP_CORE_DIR: /var/www/html
    volumes:
      - ./wp-content:/var/www/html/wp-content
    entrypoint: >
      sh -c "
        echo 'Waiting for WordPress test container...' &&
        sleep 5 &&

        echo 'Installing test dependencies...' &&
        cd /var/www/html/wp-content &&

        if [ -f composer.json ]; then
          composer install --no-interaction --prefer-dist
        fi &&

        echo 'Setting up WordPress test suite...' &&
        mkdir -p /tmp/wordpress-tests-lib &&

        curl -sL https://raw.githubusercontent.com/wp-phpunit/wp-phpunit/master/wp-tests-config-sample.php \
          -o /tmp/wordpress-tests-lib/wp-tests-config.php 2>/dev/null || true &&

        echo 'Running PHPUnit tests...' &&

        for plugin_dir in /var/www/html/wp-content/plugins/bmn-*/; do
          if [ -f \"\$$plugin_dir/phpunit.xml\" ] || [ -f \"\$$plugin_dir/phpunit.xml.dist\" ]; then
            plugin_name=\$$(basename \"\$$plugin_dir\")
            echo \"======================================\" &&
            echo \"Running tests for: \$$plugin_name\" &&
            echo \"======================================\" &&
            cd \"\$$plugin_dir\" &&
            if [ -f vendor/bin/phpunit ]; then
              php vendor/bin/phpunit
            elif command -v phpunit > /dev/null 2>&1; then
              phpunit
            else
              echo \"PHPUnit not found for \$$plugin_name, skipping.\"
            fi
          fi
        done &&

        if [ -f /var/www/html/wp-content/mu-plugins/bmn-platform/phpunit.xml ] || \
           [ -f /var/www/html/wp-content/mu-plugins/bmn-platform/phpunit.xml.dist ]; then
          echo '======================================' &&
          echo 'Running tests for: bmn-platform (mu-plugin)' &&
          echo '======================================' &&
          cd /var/www/html/wp-content/mu-plugins/bmn-platform &&
          if [ -f vendor/bin/phpunit ]; then
            php vendor/bin/phpunit
          fi
        fi &&

        echo 'All tests complete.'
      "
    depends_on:
      mysql-test:
        condition: service_healthy
      wordpress-test:
        condition: service_started
    networks:
      - bmn-test-network

networks:
  bmn-test-network:
    name: bmn-test-network
    driver: bridge
